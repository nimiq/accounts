import Vue from 'vue';
import Vuex, { StoreOptions } from 'vuex';
import {ParsedRpcRequest} from '@/lib/RequestTypes';
import {KeyInfo} from '@/lib/KeyInfo';
import {State as RpcState} from '@nimiq/rpc';
import {KeyStore} from '@/lib/KeyStore';
import {RpcResult as KeyguardResult} from '@/lib/keyguard/RequestTypes';

Vue.use(Vuex);

export interface RootState {
    request?: ParsedRpcRequest;
    rpcState: RpcState | null;
    keys: KeyInfo[]; // TODO: this is not JSON compatible, is this a problem?
    keyguardResult: KeyguardResult | Error | null;
    waitingForKeyguard: boolean;
}

const store: StoreOptions<RootState> = {
    state: {
        rpcState: null, // undefined is not reactive
        keys: [],
        keyguardResult: null, // undefined is not reactive
        waitingForKeyguard: false,
    },
    mutations: {
        setIncomingRequest(state, payload) {
            state.rpcState = payload.rpcState;
            state.request = payload.request;
        },
        initKeys(state, keys) {
            state.keys = keys;
        },
        addKey(state, key: KeyInfo) {
            state.keys.push(key);
        },
        setKeyguardResult(state, payload) {
            state.keyguardResult = payload;
        },
        waitForKeyguard(state) {
            state.waitingForKeyguard = true;
        },
    },
    actions: {
        initKeys({ commit }) {
            // Fetch data from store
            KeyStore.Instance.list().then((keys: KeyInfo[]) => {
                commit('initKeys', keys);
            });
        },
    },
};

export default new Vuex.Store<RootState>(store);
